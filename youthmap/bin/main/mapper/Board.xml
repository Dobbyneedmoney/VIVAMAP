<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.dao.BoardDao">

	<!-- 게시글 등록 -->
    <insert id="insert" parameterType="com.example.demo.model.Board">
    INSERT INTO board (
        board_no, mem_id, board_category, board_subject,
        board_content, board_readcount, board_date, mem_no
    ) VALUES (
        #{boardNo},        <!-- ✅ Java에서 set한 값 그대로 사용 -->
        #{memId},
        #{boardCategory},
        #{boardSubject},
        #{boardContent},
        0,
        SYSDATE,
        #{memNo}
    )
</insert>

    <select id="count" parameterType="map" resultType="int">
    SELECT COUNT(*) FROM board
    <where>
        <if test="category != null and category != ''">
            board_category = #{category}
        </if>
        <if test="searchType != null and keyword != null and keyword != ''">
            <choose>
                <when test="searchType == 'subject'">
                    AND board_subject LIKE '%' || #{keyword} || '%'
                </when>
                <when test="searchType == 'content'">
                    AND board_content LIKE '%' || #{keyword} || '%'
                </when>
                <when test="searchType == 'writer'">
                    AND mem_id LIKE '%' || #{keyword} || '%'
                </when>
            </choose>
        </if>
    </where>
</select>

    <select id="list" parameterType="map" resultType="com.example.demo.model.Board">
    SELECT board_no AS boardNo,
           mem_id AS memId,
           board_category AS boardCategory,
           board_subject AS boardSubject,
           board_content AS boardContent,
           board_readcount AS boardReadcount,
           board_date AS boardDate,
           mem_no AS memNo,
           rnum
    FROM (
        SELECT b.*, ROWNUM AS rnum
        FROM (
            SELECT * FROM board
            <where>
                <if test="category != null and category != ''">
                    AND board_category = #{category}
                </if>
                <if test="excludeCategory != null and excludeCategory != ''">
                    AND board_category != #{excludeCategory}
                </if>
                <if test="searchType != null and keyword != null and keyword != ''">
                    <choose>
                        <when test="searchType == 'subject'">
                            AND board_subject LIKE '%' || #{keyword} || '%'
                        </when>
                        <when test="searchType == 'content'">
                            AND board_content LIKE '%' || #{keyword} || '%'
                        </when>
                        <otherwise>
                            AND (board_subject LIKE '%' || #{keyword} || '%' OR board_content LIKE '%' || #{keyword} || '%')
                        </otherwise>
                    </choose>
                </if>
            </where>
                ORDER BY board_no DESC
        ) b
        WHERE ROWNUM &lt;= #{end}
    )
    WHERE rnum &gt;= #{start}
</select>

    <!-- 게시글 조회수 증가 -->
    <update id="updatecount" parameterType="int">
        UPDATE board
        SET board_readcount = board_readcount + 1
        WHERE board_no = #{no}
    </update>

    <select id="content" parameterType="int" resultType="com.example.demo.model.Board">
    SELECT board_no AS boardNo,
           mem_id AS memId,
           board_category AS boardCategory,
           board_subject AS boardSubject,
           board_content AS boardContent,
           board_readcount AS boardReadcount,
           board_date AS boardDate,
           mem_no AS memNo
    FROM board
    WHERE board_no = #{no}
</select>

    <!-- 게시글 수정 -->
    <update id="update" parameterType="com.example.demo.model.Board">
        UPDATE board
        SET board_category = #{boardCategory},
            board_subject = #{boardSubject},
            board_content = #{boardContent}
        WHERE board_no = #{boardNo}
    </update>

    <!-- 게시글 삭제 -->
    <delete id="delete" parameterType="int">
        DELETE FROM board
        WHERE board_no = #{no}
    </delete>
    
    <!-- 게시글 중 가장 최근 번호 조회 -->
<select id="getLastBoardNo" resultType="int">
    SELECT MAX(board_no) FROM board
</select>

<!-- 공지사항 3개 고정용 -->
<select id="getTopNotices" resultType="com.example.demo.model.Board">
    SELECT board_no AS boardNo,
           mem_id AS memId,
           board_category AS boardCategory,
           board_subject AS boardSubject,
           board_content AS boardContent,
           board_readcount AS boardReadcount,
           board_date AS boardDate,
           mem_no AS memNo
    FROM (
        SELECT * FROM board
        WHERE board_category = '공지사항'
        ORDER BY board_no DESC
    )
    WHERE ROWNUM &lt;= 3
</select>
		
</mapper>